name: Build TDLib JNI

on:
  workflow_dispatch:
    inputs:
      build_windows:
        description: 'Build for Windows x64'
        required: true
        type: boolean
        default: true
      build_linux:
        description: 'Build for Linux (Ubuntu 22.04)'
        required: true
        type: boolean
        default: true
      build_android:
        description: 'Build for Android'
        required: true
        type: boolean
        default: true
      build_javadoc:
        description: 'Build Java and documentation'
        required: true
        type: boolean
        default: false
      tdlib_commit:
        description: 'TDLib commit/branch (empty = latest)'
        required: false
        default: ''

env:
  TDLIB_REPO: https://github.com/tdlib/td.git
  OPENSSL_VERSION: '3.0.12'

jobs:
  # ============================================
  # Get latest TDLib commit
  # ============================================
  get-tdlib-version:
    runs-on: ubuntu-latest
    outputs:
      commit_sha: ${{ steps.get-commit.outputs.sha }}
      commit_short: ${{ steps.get-commit.outputs.short }}
    
    steps:
      - name: Get TDLib commit
        id: get-commit
        run: |
          if [ -n "${{ inputs.tdlib_commit }}" ]; then
            COMMIT_SHA=$(git ls-remote ${{ env.TDLIB_REPO }} ${{ inputs.tdlib_commit }} | head -1 | cut -f1)
            if [ -z "$COMMIT_SHA" ]; then
              COMMIT_SHA="${{ inputs.tdlib_commit }}"
            fi
          else
            COMMIT_SHA=$(git ls-remote ${{ env.TDLIB_REPO }} HEAD | cut -f1)
          fi
          
          COMMIT_SHORT=${COMMIT_SHA:0:7}
          
          echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
          echo "Using TDLib commit: $COMMIT_SHA ($COMMIT_SHORT)"

  # ============================================
  # Windows x64 Build (Static)
  # ============================================
  build-windows:
    if: ${{ inputs.build_windows }}
    needs: get-tdlib-version
    runs-on: windows-2022
    
    steps:
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set JAVA_HOME with forward slashes
        shell: bash
        run: |
          JAVA_HOME_FIXED=$(echo "$JAVA_HOME" | sed 's|\\|/|g')
          echo "JAVA_HOME_CMAKE=$JAVA_HOME_FIXED" >> $GITHUB_ENV

      - name: Install gperf
        run: choco install gperf -y

      - name: Install vcpkg and dependencies (static)
        shell: pwsh
        run: |
          cd ${{ github.workspace }}
          git clone https://github.com/Microsoft/vcpkg.git
          cd vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg install openssl:x64-windows-static zlib:x64-windows-static

      - name: Clone TDLib
        shell: bash
        run: |
          git clone ${{ env.TDLIB_REPO }} td
          cd td
          git checkout ${{ needs.get-tdlib-version.outputs.commit_sha }}

      - name: Patch CMakeLists.txt to skip javadoc
        shell: bash
        run: |
          cd td/example/java
          
          python3 << 'EOF'
          import re
          
          with open('CMakeLists.txt', 'r') as f:
              content = f.read()
          
          content = re.sub(
              r'add_dependencies\(tdjni\s+td_generate_java_api\s+build_java\s+generate_javadoc\)',
              'add_dependencies(tdjni td_generate_java_api)',
              content
          )
          content = re.sub(
              r'add_dependencies\(tdjni\s+td_generate_java_api\s+generate_javadoc\s+build_java\)',
              'add_dependencies(tdjni td_generate_java_api)',
              content
          )
          content = re.sub(
              r'add_dependencies\(tdjni\s+td_generate_java_api[^)]*build_java[^)]*\)',
              'add_dependencies(tdjni td_generate_java_api)',
              content
          )
          
          with open('CMakeLists.txt', 'w') as f:
              f.write(content)
          EOF

      - name: Configure TDLib with JNI
        shell: bash
        run: |
          cd td
          mkdir -p jnibuild
          cd jnibuild
          
          cmake -G "Visual Studio 17 2022" -A x64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" \
            -DVCPKG_TARGET_TRIPLET=x64-windows-static \
            -DTD_ENABLE_JNI=ON \
            -DJAVA_HOME="$JAVA_HOME_CMAKE" \
            -DCMAKE_INSTALL_PREFIX:PATH=../example/java/td \
            ..

      - name: Build TDLib
        shell: pwsh
        run: |
          cd td/jnibuild
          cmake --build . --config Release --parallel 4
          
      - name: Install TDLib
        shell: pwsh
        run: |
          cd td/jnibuild
          cmake --install . --config Release

      - name: Configure JNI Wrapper
        shell: bash
        run: |
          cd td/example/java
          mkdir -p build
          cd build
          
          cmake -G "Visual Studio 17 2022" -A x64 \
            -DCMAKE_BUILD_TYPE=Release \
            -DTd_DIR="${{ github.workspace }}/td/example/java/td/lib/cmake/Td" \
            -DJAVA_HOME="$JAVA_HOME_CMAKE" \
            ..

      - name: Build JNI Wrapper
        shell: pwsh
        run: |
          cd td/example/java/build
          cmake --build . --config Release --target tdjni

      - name: Find and prepare artifacts
        shell: pwsh
        run: |
          mkdir -p artifacts/windows-x64
          
          $dllFiles = Get-ChildItem -Path td -Recurse -Filter "tdjni.dll" -ErrorAction SilentlyContinue
          
          if ($dllFiles) {
            Copy-Item $dllFiles[0].FullName -Destination artifacts/windows-x64/
            
            Write-Host "=== DLL Dependencies ==="
            dumpbin /dependents $dllFiles[0].FullName
          } else {
            Write-Host "tdjni.dll not found!"
            exit 1
          }

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-jni-windows-x64-${{ needs.get-tdlib-version.outputs.commit_short }}
          path: artifacts/windows-x64/tdjni.dll

  # ============================================
  # Linux (Ubuntu 22.04) Build (Dynamic)
  # ============================================
  build-linux:
    if: ${{ inputs.build_linux }}
    needs: get-tdlib-version
    runs-on: ubuntu-22.04
    
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            gperf \
            libssl-dev \
            zlib1g-dev \
            php-cli

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Clone TDLib
        run: |
          git clone ${{ env.TDLIB_REPO }} td
          cd td
          git checkout ${{ needs.get-tdlib-version.outputs.commit_sha }}

      - name: Configure TDLib with JNI
        run: |
          cd td
          mkdir -p jnibuild
          cd jnibuild
          cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DTD_ENABLE_JNI=ON \
            -DCMAKE_INSTALL_PREFIX:PATH=../example/java/td \
            ..

      - name: Build and Install TDLib
        run: |
          cd td/jnibuild
          cmake --build . --target install --parallel $(nproc)

      - name: Patch CMakeLists.txt to skip javadoc
        run: |
          cd td/example/java
          
          python3 << 'EOF'
          import re
          
          with open('CMakeLists.txt', 'r') as f:
              content = f.read()
          
          content = re.sub(
              r'add_dependencies\(tdjni\s+td_generate_java_api\s+build_java\s+generate_javadoc\)',
              'add_dependencies(tdjni td_generate_java_api)',
              content
          )
          content = re.sub(
              r'add_dependencies\(tdjni\s+td_generate_java_api\s+generate_javadoc\s+build_java\)',
              'add_dependencies(tdjni td_generate_java_api)',
              content
          )
          content = re.sub(
              r'add_dependencies\(tdjni\s+td_generate_java_api[^)]*build_java[^)]*\)',
              'add_dependencies(tdjni td_generate_java_api)',
              content
          )
          
          with open('CMakeLists.txt', 'w') as f:
              f.write(content)
          EOF

      - name: Configure JNI Wrapper
        run: |
          cd td/example/java
          mkdir -p build
          cd build
          cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DTd_DIR=${{ github.workspace }}/td/example/java/td/lib/cmake/Td \
            ..

      - name: Build JNI Wrapper
        run: |
          cd td/example/java/build
          cmake --build . --target tdjni --parallel $(nproc)

      - name: Find and prepare artifacts
        run: |
          mkdir -p artifacts/linux-x64
          
          SO_FILE=$(find td -name "libtdjni.so" -type f 2>/dev/null | head -1)
          
          if [ -n "$SO_FILE" ]; then
            cp "$SO_FILE" artifacts/linux-x64/
            
            echo "=== Library Dependencies ==="
            ldd "$SO_FILE"
            
            echo "=== File size ==="
            ls -lh "$SO_FILE"
          else
            echo "libtdjni.so not found!"
            exit 1
          fi

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-jni-linux-x64-${{ needs.get-tdlib-version.outputs.commit_short }}
          path: artifacts/linux-x64/libtdjni.so

  # ============================================
  # Android Build (all architectures)
  # ============================================
  build-android:
    if: ${{ inputs.build_android }}
    needs: get-tdlib-version
    runs-on: ubuntu-22.04
    
    strategy:
      fail-fast: false
      matrix:
        abi: [armeabi-v7a, arm64-v8a, x86, x86_64]
        include:
          - abi: armeabi-v7a
            api_level: 21
          - abi: arm64-v8a
            api_level: 21
          - abi: x86
            api_level: 21
          - abi: x86_64
            api_level: 21

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            gperf \
            ninja-build \
            php-cli \
            libssl-dev \
            zlib1g-dev

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager --install "ndk;26.1.10909125"
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV
          echo "ANDROID_NDK=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV

      - name: Clone TDLib
        run: |
          git clone ${{ env.TDLIB_REPO }} td
          cd td
          git checkout ${{ needs.get-tdlib-version.outputs.commit_sha }}

      - name: Build native generators (host build)
        run: |
          cd td
          mkdir -p build-native
          cd build-native
          
          cmake \
            -DCMAKE_BUILD_TYPE=Release \
            ..
          
          cmake --build . --target prepare_cross_compiling --parallel $(nproc)

      - name: Build OpenSSL for Android
        run: |
          wget -q https://www.openssl.org/source/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          tar -xzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz
          
          OPENSSL_DIR=${{ github.workspace }}/openssl-${{ env.OPENSSL_VERSION }}
          INSTALL_DIR=${{ github.workspace }}/openssl-android/${{ matrix.abi }}
          mkdir -p $INSTALL_DIR
          
          cd $OPENSSL_DIR
          
          case "${{ matrix.abi }}" in
            armeabi-v7a) ANDROID_ARCH=android-arm ;;
            arm64-v8a)   ANDROID_ARCH=android-arm64 ;;
            x86)         ANDROID_ARCH=android-x86 ;;
            x86_64)      ANDROID_ARCH=android-x86_64 ;;
          esac
          
          export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          export ANDROID_NDK_ROOT=$ANDROID_NDK_HOME
          
          ./Configure $ANDROID_ARCH \
            -D__ANDROID_API__=${{ matrix.api_level }} \
            --prefix=$INSTALL_DIR \
            no-shared \
            no-tests
          
          make -j $(nproc)
          make install_sw

      - name: Configure TDLib for Android (cross-compile)
        run: |
          cd td
          mkdir -p build-android-${{ matrix.abi }}
          cd build-android-${{ matrix.abi }}
          
          OPENSSL_DIR=${{ github.workspace }}/openssl-android/${{ matrix.abi }}
          
          cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-${{ matrix.api_level }} \
            -DANDROID_STL=c++_static \
            -DTD_ENABLE_JNI=ON \
            -DOPENSSL_ROOT_DIR=$OPENSSL_DIR \
            -DOPENSSL_INCLUDE_DIR=$OPENSSL_DIR/include \
            -DOPENSSL_CRYPTO_LIBRARY=$OPENSSL_DIR/lib/libcrypto.a \
            -DOPENSSL_SSL_LIBRARY=$OPENSSL_DIR/lib/libssl.a \
            -DCMAKE_INSTALL_PREFIX:PATH=../example/java/td \
            -GNinja \
            ..

      - name: Build and Install TDLib for Android
        run: |
          cd td/build-android-${{ matrix.abi }}
          ninja
          ninja install

      - name: Create custom CMakeLists.txt for Android JNI
        run: |
          cd td/example/java
          
          # Backup original
          cp CMakeLists.txt CMakeLists.txt.original
          
          # Create new CMakeLists.txt for Android
          cat > CMakeLists.txt << 'CMAKEFILE'
          cmake_minimum_required(VERSION 3.4 FATAL_ERROR)
          project(TdJavaExample VERSION 1.0 LANGUAGES CXX)
          
          set(CMAKE_CXX_STANDARD 17)
          set(CMAKE_CXX_STANDARD_REQUIRED ON)
          
          # For Android, we only need JNI headers, not JVM
          if(ANDROID)
            # Use JNI headers from host JDK
            if(DEFINED ENV{JAVA_HOME})
              set(JNI_INCLUDE_DIRS "$ENV{JAVA_HOME}/include" "$ENV{JAVA_HOME}/include/linux")
            else()
              message(FATAL_ERROR "JAVA_HOME not set")
            endif()
          else()
            find_package(JNI REQUIRED)
          endif()
          
          find_package(Td REQUIRED)
          
          # Source files
          if(NOT DEFINED TD_API_JAVA_PACKAGE)
            set(TD_API_JAVA_PACKAGE "org/drinkless/tdlib")
          endif()
          
          set(TD_API_TLO_PATH ${CMAKE_CURRENT_SOURCE_DIR}/td/bin/td/generate/scheme/td_api.tlo)
          set(TD_API_TL_PATH ${CMAKE_CURRENT_SOURCE_DIR}/td/bin/td/generate/scheme/td_api.tl)
          set(JAVA_OUTPUT_DIR ${CMAKE_CURRENT_SOURCE_DIR})
          
          set(TD_API_JAVA_PATH ${JAVA_OUTPUT_DIR}/${TD_API_JAVA_PACKAGE}/TdApi.java)
          
          # Generate Java API
          add_custom_command(
            OUTPUT ${TD_API_JAVA_PATH}
            COMMAND ${CMAKE_COMMAND} -E make_directory ${JAVA_OUTPUT_DIR}/${TD_API_JAVA_PACKAGE}
            COMMAND ${PHP_EXECUTABLE} ${CMAKE_CURRENT_SOURCE_DIR}/td/bin/td/generate/JavadocTlDocumentationGenerator.php ${TD_API_TLO_PATH} ${TD_API_JAVA_PATH} ${TD_API_JAVA_PACKAGE}
            DEPENDS ${TD_API_TLO_PATH} ${TD_API_TL_PATH}
            COMMENT "Generating Java TdApi"
          )
          add_custom_target(td_generate_java_api DEPENDS ${TD_API_JAVA_PATH})
          
          # tdjni library
          add_library(tdjni SHARED
            td_jni.cpp
          )
          
          target_include_directories(tdjni PRIVATE ${JNI_INCLUDE_DIRS})
          target_link_libraries(tdjni PRIVATE Td::TdJsonStatic)
          
          add_dependencies(tdjni td_generate_java_api)
          
          set_target_properties(tdjni PROPERTIES
            OUTPUT_NAME "tdjni"
          )
          CMAKEFILE
          
          echo "=== New CMakeLists.txt ==="
          cat CMakeLists.txt

      - name: Configure JNI Wrapper for Android
        run: |
          cd td/example/java
          mkdir -p build-android-${{ matrix.abi }}
          cd build-android-${{ matrix.abi }}
          
          cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-${{ matrix.api_level }} \
            -DANDROID_STL=c++_static \
            -DTd_DIR=${{ github.workspace }}/td/example/java/td/lib/cmake/Td \
            -DPHP_EXECUTABLE=/usr/bin/php \
            -GNinja \
            ..

      - name: Build JNI Wrapper for Android
        run: |
          cd td/example/java/build-android-${{ matrix.abi }}
          ninja tdjni

      - name: Find and prepare artifacts
        run: |
          mkdir -p artifacts/android/${{ matrix.abi }}
          
          SO_FILE=$(find td -name "libtdjni.so" -type f 2>/dev/null | head -1)
          
          if [ -n "$SO_FILE" ]; then
            cp "$SO_FILE" artifacts/android/${{ matrix.abi }}/
            
            echo "=== File info ==="
            file "$SO_FILE"
            ls -lh "$SO_FILE"
          else
            echo "libtdjni.so not found!"
            exit 1
          fi

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-jni-android-${{ matrix.abi }}-${{ needs.get-tdlib-version.outputs.commit_short }}
          path: artifacts/android/${{ matrix.abi }}/libtdjni.so

  # ============================================
  # Build Javadoc Documentation
  # ============================================
  build-javadoc:
    if: ${{ inputs.build_javadoc }}
    needs: get-tdlib-version
    runs-on: ubuntu-22.04
    
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            gperf \
            libssl-dev \
            zlib1g-dev \
            php-cli

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Clone TDLib
        run: |
          git clone ${{ env.TDLIB_REPO }} td
          cd td
          git checkout ${{ needs.get-tdlib-version.outputs.commit_sha }}

      - name: Configure TDLib with JNI
        run: |
          cd td
          mkdir -p jnibuild
          cd jnibuild
          cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DTD_ENABLE_JNI=ON \
            -DCMAKE_INSTALL_PREFIX:PATH=../example/java/td \
            ..

      - name: Build and Install TDLib
        run: |
          cd td/jnibuild
          cmake --build . --target install --parallel $(nproc)

      - name: Generate Java API
        run: |
          cd td/example/java
          mkdir -p build
          cd build
          cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DTd_DIR=${{ github.workspace }}/td/example/java/td/lib/cmake/Td \
            ..
          cmake --build . --target td_generate_java_api

      - name: Generate Javadoc
        run: |
          cd td/example/java
          mkdir -p docs
          
          javadoc \
            -d docs \
            -sourcepath . \
            -windowtitle "TDLib Java API" \
            -doctitle "TDLib Java API Documentation" \
            -header "TDLib JNI" \
            -Xdoclint:none \
            -quiet \
            org/drinkless/tdlib/TdApi.java \
            org/drinkless/tdlib/Client.java \
            2>/dev/null || true
          
          if [ ! -f "docs/index.html" ]; then
            echo "Creating minimal docs..."
            mkdir -p docs
            cat > docs/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head><title>TDLib Java API</title></head>
          <body>
          <h1>TDLib Java API</h1>
          <p>Please refer to the source files: TdApi.java and Client.java</p>
          </body>
          </html>
          HTMLEOF
          fi

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts/javadoc
          mkdir -p artifacts/java-sources/org/drinkless/tdlib
          
          cp -r td/example/java/docs/* artifacts/javadoc/ || true
          cp td/example/java/org/drinkless/tdlib/TdApi.java artifacts/java-sources/org/drinkless/tdlib/
          cp td/example/java/org/drinkless/tdlib/Client.java artifacts/java-sources/org/drinkless/tdlib/
          
          cat > artifacts/VERSION.txt << EOF
          TDLib Javadoc
          TDLib commit: ${{ needs.get-tdlib-version.outputs.commit_sha }}
          Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF

      - name: Upload Javadoc artifact
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-javadoc-${{ needs.get-tdlib-version.outputs.commit_short }}
          path: artifacts/

  # ============================================
  # Combine all artifacts
  # ============================================
  combine-artifacts:
    runs-on: ubuntu-latest
    needs: [get-tdlib-version, build-windows, build-linux, build-android, build-javadoc]
    if: |
      always() && 
      (needs.build-windows.result == 'success' || 
       needs.build-linux.result == 'success' || 
       needs.build-android.result == 'success' ||
       needs.build-javadoc.result == 'success')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Organize artifacts
        run: |
          COMMIT_SHORT=${{ needs.get-tdlib-version.outputs.commit_short }}
          COMMIT_FULL=${{ needs.get-tdlib-version.outputs.commit_sha }}
          
          mkdir -p release/windows-x64
          mkdir -p release/linux-x64
          mkdir -p release/android/armeabi-v7a
          mkdir -p release/android/arm64-v8a
          mkdir -p release/android/x86
          mkdir -p release/android/x86_64
          mkdir -p release/javadoc
          mkdir -p release/java-sources
          
          # Copy binaries
          [ -d "all-artifacts/tdlib-jni-windows-x64-$COMMIT_SHORT" ] && cp all-artifacts/tdlib-jni-windows-x64-$COMMIT_SHORT/* release/windows-x64/ || true
          [ -d "all-artifacts/tdlib-jni-linux-x64-$COMMIT_SHORT" ] && cp all-artifacts/tdlib-jni-linux-x64-$COMMIT_SHORT/* release/linux-x64/ || true
          [ -d "all-artifacts/tdlib-jni-android-armeabi-v7a-$COMMIT_SHORT" ] && cp all-artifacts/tdlib-jni-android-armeabi-v7a-$COMMIT_SHORT/* release/android/armeabi-v7a/ || true
          [ -d "all-artifacts/tdlib-jni-android-arm64-v8a-$COMMIT_SHORT" ] && cp all-artifacts/tdlib-jni-android-arm64-v8a-$COMMIT_SHORT/* release/android/arm64-v8a/ || true
          [ -d "all-artifacts/tdlib-jni-android-x86-$COMMIT_SHORT" ] && cp all-artifacts/tdlib-jni-android-x86-$COMMIT_SHORT/* release/android/x86/ || true
          [ -d "all-artifacts/tdlib-jni-android-x86_64-$COMMIT_SHORT" ] && cp all-artifacts/tdlib-jni-android-x86_64-$COMMIT_SHORT/* release/android/x86_64/ || true
          
          # Copy javadoc
          if [ -d "all-artifacts/tdlib-javadoc-$COMMIT_SHORT" ]; then
            [ -d "all-artifacts/tdlib-javadoc-$COMMIT_SHORT/javadoc" ] && cp -r all-artifacts/tdlib-javadoc-$COMMIT_SHORT/javadoc/* release/javadoc/ || true
            [ -d "all-artifacts/tdlib-javadoc-$COMMIT_SHORT/java-sources" ] && cp -r all-artifacts/tdlib-javadoc-$COMMIT_SHORT/java-sources/* release/java-sources/ || true
          fi
          
          # Remove empty directories
          find release -type d -empty -delete 2>/dev/null || true
          
          # Create VERSION.txt
          cat > release/VERSION.txt << EOL
          TDLib JNI Build Information
          ===========================
          TDLib commit: $COMMIT_FULL
          TDLib commit (short): $COMMIT_SHORT
          Build date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          Platforms:
          - Windows x64 (static linking)
          - Linux x64 (dynamic linking, requires libssl, libcrypto, zlib)
          - Android armeabi-v7a (API 21+, static linking)
          - Android arm64-v8a (API 21+, static linking)
          - Android x86 (API 21+, static linking)
          - Android x86_64 (API 21+, static linking)
          EOL
          
          echo "=== Build artifacts ==="
          find release -type f -ls

      - name: Upload combined release
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-jni-all-platforms-${{ needs.get-tdlib-version.outputs.commit_short }}
          path: release/
