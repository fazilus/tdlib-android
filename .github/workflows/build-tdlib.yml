name: Build TDLib JNI

on:
  workflow_dispatch:
    inputs:
      build_windows:
        description: 'Build for Windows x64'
        required: true
        type: boolean
        default: true
      build_linux:
        description: 'Build for Linux (Ubuntu 22.04)'
        required: true
        type: boolean
        default: true
      build_android:
        description: 'Build for Android (all architectures)'
        required: true
        type: boolean
        default: true
      tdlib_commit:
        description: 'TDLib commit/branch (empty = latest)'
        required: false
        default: ''

env:
  TDLIB_REPO: https://github.com/tdlib/td.git

jobs:
  # ============================================
  # Get latest TDLib commit
  # ============================================
  get-tdlib-version:
    runs-on: ubuntu-latest
    outputs:
      commit_sha: ${{ steps.get-commit.outputs.sha }}
      commit_short: ${{ steps.get-commit.outputs.short }}
    
    steps:
      - name: Get TDLib commit
        id: get-commit
        run: |
          if [ -n "${{ inputs.tdlib_commit }}" ]; then
            COMMIT_SHA=$(git ls-remote ${{ env.TDLIB_REPO }} ${{ inputs.tdlib_commit }} | head -1 | cut -f1)
            if [ -z "$COMMIT_SHA" ]; then
              COMMIT_SHA="${{ inputs.tdlib_commit }}"
            fi
          else
            COMMIT_SHA=$(git ls-remote ${{ env.TDLIB_REPO }} HEAD | cut -f1)
          fi
          
          COMMIT_SHORT=${COMMIT_SHA:0:7}
          
          echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
          echo "Using TDLib commit: $COMMIT_SHA ($COMMIT_SHORT)"

  # ============================================
  # Windows x64 Build
  # ============================================
  build-windows:
    if: ${{ inputs.build_windows }}
    needs: get-tdlib-version
    runs-on: windows-2022
    
    steps:
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install gperf
        run: choco install gperf -y

      - name: Install vcpkg and dependencies
        run: |
          cd ${{ github.workspace }}
          git clone https://github.com/Microsoft/vcpkg.git
          cd vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg install openssl:x64-windows zlib:x64-windows
          
          # Verify installation
          echo "=== Installed packages ==="
          .\vcpkg list

      - name: Clone TDLib
        run: |
          git clone ${{ env.TDLIB_REPO }} td
          cd td
          git checkout ${{ needs.get-tdlib-version.outputs.commit_sha }}
          echo "Checked out TDLib at commit: $(git rev-parse HEAD)"

      - name: Configure TDLib with JNI
        run: |
          cd td
          mkdir jnibuild
          cd jnibuild
          
          $env:VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
          
          cmake -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows `
            -DTD_ENABLE_JNI=ON `
            -DJAVA_HOME="$env:JAVA_HOME" `
            -DJAVA_INCLUDE_PATH="$env:JAVA_HOME/include" `
            -DJAVA_AWT_LIBRARY="$env:JAVA_HOME/lib/jawt.lib" `
            -DJAVA_JVM_LIBRARY="$env:JAVA_HOME/lib/jvm.lib" `
            -DCMAKE_INSTALL_PREFIX:PATH="../tdlib-install" `
            ..
          
          echo "=== CMake configuration complete ==="

      - name: Build TDLib
        run: |
          cd td/jnibuild
          cmake --build . --config Release --parallel 4
          
      - name: Install TDLib
        run: |
          cd td/jnibuild
          cmake --install . --config Release

      - name: Configure JNI Wrapper
        run: |
          cd td/example/java
          mkdir build
          cd build
          
          cmake -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DTd_DIR="${{ github.workspace }}/td/tdlib-install/lib/cmake/Td" `
            -DJAVA_HOME="$env:JAVA_HOME" `
            -DJAVA_INCLUDE_PATH="$env:JAVA_HOME/include" `
            -DJAVA_AWT_LIBRARY="$env:JAVA_HOME/lib/jawt.lib" `
            -DJAVA_JVM_LIBRARY="$env:JAVA_HOME/lib/jvm.lib" `
            ..
          
          echo "=== JNI Wrapper CMake configuration complete ==="

      - name: Build JNI Wrapper
        run: |
          cd td/example/java/build
          cmake --build . --config Release --target tdjni

      - name: Find and prepare artifacts
        run: |
          mkdir -p artifacts/windows-x64
          
          echo "=== Searching for tdjni.dll ==="
          $dllFiles = Get-ChildItem -Path td -Recurse -Filter "tdjni.dll" -ErrorAction SilentlyContinue
          
          if ($dllFiles) {
            foreach ($dll in $dllFiles) {
              Write-Host "Found: $($dll.FullName)"
            }
            Copy-Item $dllFiles[0].FullName -Destination artifacts/windows-x64/
          } else {
            Write-Host "tdjni.dll not found! All DLLs:"
            Get-ChildItem -Path td -Recurse -Filter "*.dll" | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-jni-windows-x64-${{ needs.get-tdlib-version.outputs.commit_short }}
          path: artifacts/windows-x64/tdjni.dll

  # ============================================
  # Linux (Ubuntu 22.04) Build
  # ============================================
  build-linux:
    if: ${{ inputs.build_linux }}
    needs: get-tdlib-version
    runs-on: ubuntu-22.04
    
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            gperf \
            libssl-dev \
            zlib1g-dev

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Clone TDLib
        run: |
          git clone ${{ env.TDLIB_REPO }} td
          cd td
          git checkout ${{ needs.get-tdlib-version.outputs.commit_sha }}
          echo "Checked out TDLib at commit: $(git rev-parse HEAD)"

      - name: Configure TDLib with JNI
        run: |
          cd td
          mkdir jnibuild
          cd jnibuild
          cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DTD_ENABLE_JNI=ON \
            -DJAVA_HOME="$JAVA_HOME" \
            -DCMAKE_INSTALL_PREFIX:PATH="../tdlib-install" \
            ..

      - name: Build TDLib
        run: |
          cd td/jnibuild
          cmake --build . --parallel $(nproc)

      - name: Install TDLib
        run: |
          cd td/jnibuild
          cmake --install .

      - name: Configure JNI Wrapper
        run: |
          cd td/example/java
          mkdir build
          cd build
          cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DTd_DIR="${{ github.workspace }}/td/tdlib-install/lib/cmake/Td" \
            -DJAVA_HOME="$JAVA_HOME" \
            ..

      - name: Build JNI Wrapper (tdjni only)
        run: |
          cd td/example/java/build
          cmake --build . --target tdjni --parallel $(nproc)

      - name: Find and prepare artifacts
        run: |
          mkdir -p artifacts/linux-x64
          
          echo "=== Searching for libtdjni.so ==="
          SO_FILE=$(find td -name "libtdjni.so" -type f 2>/dev/null | head -1)
          
          if [ -n "$SO_FILE" ]; then
            echo "Found: $SO_FILE"
            cp "$SO_FILE" artifacts/linux-x64/
          else
            echo "libtdjni.so not found! All .so files:"
            find td -name "*.so" -type f
            exit 1
          fi

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-jni-linux-x64-${{ needs.get-tdlib-version.outputs.commit_short }}
          path: artifacts/linux-x64/libtdjni.so

  # ============================================
  # Android Build (all architectures)
  # ============================================
  build-android:
    if: ${{ inputs.build_android }}
    needs: get-tdlib-version
    runs-on: ubuntu-22.04
    
    strategy:
      fail-fast: false
      matrix:
        abi: [armeabi-v7a, arm64-v8a, x86, x86_64]
        include:
          - abi: armeabi-v7a
            api_level: 21
          - abi: arm64-v8a
            api_level: 21
          - abi: x86
            api_level: 21
          - abi: x86_64
            api_level: 21

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            gperf \
            ninja-build \
            php-cli

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          sdkmanager --install "ndk;26.1.10909125"
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV
          echo "ANDROID_NDK=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV

      - name: Clone TDLib
        run: |
          git clone ${{ env.TDLIB_REPO }} td
          cd td
          git checkout ${{ needs.get-tdlib-version.outputs.commit_sha }}
          echo "Checked out TDLib at commit: $(git rev-parse HEAD)"

      - name: Build OpenSSL for Android
        run: |
          wget -q https://www.openssl.org/source/openssl-3.0.12.tar.gz
          tar -xzf openssl-3.0.12.tar.gz
          
          OPENSSL_DIR=${{ github.workspace }}/openssl-3.0.12
          INSTALL_DIR=${{ github.workspace }}/openssl-android/${{ matrix.abi }}
          mkdir -p $INSTALL_DIR
          
          cd $OPENSSL_DIR
          
          case "${{ matrix.abi }}" in
            armeabi-v7a) ANDROID_ARCH=android-arm ;;
            arm64-v8a)   ANDROID_ARCH=android-arm64 ;;
            x86)         ANDROID_ARCH=android-x86 ;;
            x86_64)      ANDROID_ARCH=android-x86_64 ;;
          esac
          
          export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          export ANDROID_NDK_ROOT=$ANDROID_NDK_HOME
          
          ./Configure $ANDROID_ARCH \
            -D__ANDROID_API__=${{ matrix.api_level }} \
            --prefix=$INSTALL_DIR \
            no-shared \
            no-tests
          
          make -j $(nproc)
          make install_sw

      - name: Configure TDLib for Android
        run: |
          cd td
          mkdir build-android-${{ matrix.abi }}
          cd build-android-${{ matrix.abi }}
          
          OPENSSL_DIR=${{ github.workspace }}/openssl-android/${{ matrix.abi }}
          
          cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-${{ matrix.api_level }} \
            -DANDROID_STL=c++_static \
            -DTD_ENABLE_JNI=ON \
            -DOPENSSL_ROOT_DIR=$OPENSSL_DIR \
            -DOPENSSL_INCLUDE_DIR=$OPENSSL_DIR/include \
            -DOPENSSL_CRYPTO_LIBRARY=$OPENSSL_DIR/lib/libcrypto.a \
            -DOPENSSL_SSL_LIBRARY=$OPENSSL_DIR/lib/libssl.a \
            -DCMAKE_INSTALL_PREFIX:PATH=../tdlib-install-${{ matrix.abi }} \
            -GNinja \
            ..

      - name: Build TDLib for Android
        run: |
          cd td/build-android-${{ matrix.abi }}
          ninja
          ninja install

      - name: Configure JNI Wrapper for Android
        run: |
          cd td/example/java
          mkdir build-android-${{ matrix.abi }}
          cd build-android-${{ matrix.abi }}
          
          cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-${{ matrix.api_level }} \
            -DANDROID_STL=c++_static \
            -DTd_DIR=${{ github.workspace }}/td/tdlib-install-${{ matrix.abi }}/lib/cmake/Td \
            -GNinja \
            ..

      - name: Build JNI Wrapper for Android
        run: |
          cd td/example/java/build-android-${{ matrix.abi }}
          ninja tdjni

      - name: Find and prepare artifacts
        run: |
          mkdir -p artifacts/android/${{ matrix.abi }}
          
          echo "=== Searching for libtdjni.so ==="
          SO_FILE=$(find td -name "libtdjni.so" -type f 2>/dev/null | head -1)
          
          if [ -n "$SO_FILE" ]; then
            echo "Found: $SO_FILE"
            cp "$SO_FILE" artifacts/android/${{ matrix.abi }}/
          else
            echo "libtdjni.so not found! All .so files:"
            find td -name "*.so" -type f
            exit 1
          fi

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-jni-android-${{ matrix.abi }}-${{ needs.get-tdlib-version.outputs.commit_short }}
          path: artifacts/android/${{ matrix.abi }}/libtdjni.so

  # ============================================
  # Combine all artifacts
  # ============================================
  combine-artifacts:
    runs-on: ubuntu-latest
    needs: [get-tdlib-version, build-windows, build-linux, build-android]
    if: always() && (needs.build-windows.result == 'success' || needs.build-linux.result == 'success' || needs.build-android.result == 'success')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Organize artifacts
        run: |
          COMMIT_SHORT=${{ needs.get-tdlib-version.outputs.commit_short }}
          
          mkdir -p release/windows-x64
          mkdir -p release/linux-x64
          mkdir -p release/android/armeabi-v7a
          mkdir -p release/android/arm64-v8a
          mkdir -p release/android/x86
          mkdir -p release/android/x86_64
          
          [ -d "all-artifacts/tdlib-jni-windows-x64-$COMMIT_SHORT" ] && cp all-artifacts/tdlib-jni-windows-x64-$COMMIT_SHORT/* release/windows-x64/ || true
          [ -d "all-artifacts/tdlib-jni-linux-x64-$COMMIT_SHORT" ] && cp all-artifacts/tdlib-jni-linux-x64-$COMMIT_SHORT/* release/linux-x64/ || true
          [ -d "all-artifacts/tdlib-jni-android-armeabi-v7a-$COMMIT_SHORT" ] && cp all-artifacts/tdlib-jni-android-armeabi-v7a-$COMMIT_SHORT/* release/android/armeabi-v7a/ || true
          [ -d "all-artifacts/tdlib-jni-android-arm64-v8a-$COMMIT_SHORT" ] && cp all-artifacts/tdlib-jni-android-arm64-v8a-$COMMIT_SHORT/* release/android/arm64-v8a/ || true
          [ -d "all-artifacts/tdlib-jni-android-x86-$COMMIT_SHORT" ] && cp all-artifacts/tdlib-jni-android-x86-$COMMIT_SHORT/* release/android/x86/ || true
          [ -d "all-artifacts/tdlib-jni-android-x86_64-$COMMIT_SHORT" ] && cp all-artifacts/tdlib-jni-android-x86_64-$COMMIT_SHORT/* release/android/x86_64/ || true
          
          echo "TDLib commit: ${{ needs.get-tdlib-version.outputs.commit_sha }}" > release/VERSION.txt
          echo "Build date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> release/VERSION.txt
          
          echo "=== Build artifacts ==="
          find release -type f -ls

      - name: Upload combined release
        uses: actions/upload-artifact@v4
        with:
          name: tdlib-jni-all-platforms-${{ needs.get-tdlib-version.outputs.commit_short }}
          path: release/
